<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Run Azure images in Hyper-V or kvm - openQA bites</title><meta name=description content="Disclaimer: This blog post is about SUSE Linux Enterprise Server images on Azure and probably only useful to SUSE Employees who work with such images."><meta name=author content="phoenix"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"openQA bites","url":"https:\/\/openQA-Bites.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/openQA-Bites.github.io\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/openQA-Bites.github.io\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/openQA-Bites.github.io\/posts\/2021-12-01-run-azure-image-on-hyperv\/","name":"Run azure images in hyper v or kvm"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"phoenix"},"headline":"Run Azure images in Hyper-V or kvm","description":"Disclaimer: This blog post is about SUSE Linux Enterprise Server images on Azure and probably only useful to SUSE Employees who work with such images.","inLanguage":"en","wordCount":1124,"datePublished":"2021-12-01T14:00:11","dateModified":"2021-12-01T14:00:11","image":"https:\/\/openQA-Bites.github.io\/img\/avatar-icon.png","keywords":["SLES, Publiccloud, Hyper-V"],"mainEntityOfPage":"https:\/\/openQA-Bites.github.io\/posts\/2021-12-01-run-azure-image-on-hyperv\/","publisher":{"@type":"Organization","name":"https:\/\/openQA-Bites.github.io\/","logo":{"@type":"ImageObject","url":"https:\/\/openQA-Bites.github.io\/img\/avatar-icon.png","height":60,"width":60}}}</script><meta property="og:title" content="Run Azure images in Hyper-V or kvm"><meta property="og:description" content="Disclaimer: This blog post is about SUSE Linux Enterprise Server images on Azure and probably only useful to SUSE Employees who work with such images."><meta property="og:image" content="https://openQA-Bites.github.io/img/avatar-icon.png"><meta property="og:url" content="https://openQA-Bites.github.io/posts/2021-12-01-run-azure-image-on-hyperv/"><meta property="og:type" content="website"><meta property="og:site_name" content="openQA bites"><meta name=twitter:title content="Run Azure images in Hyper-V or kvm"><meta name=twitter:description content="Disclaimer: This blog post is about SUSE Linux Enterprise Server images on Azure and probably only useful to SUSE Employees who work with such images."><meta name=twitter:image content="https://openQA-Bites.github.io/img/avatar-icon.png"><meta name=twitter:card content="summary"><meta name=twitter:site content="@grisu48"><meta name=twitter:creator content="@grisu48"><link href=https://openQA-Bites.github.io/img/favicon.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.110.0"><link rel=alternate href=https://openQA-Bites.github.io/index.xml type=application/rss+xml title="openQA bites"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://openQA-Bites.github.io/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://openQA-Bites.github.io/css/syntax.css><link rel=stylesheet href=https://openQA-Bites.github.io/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://openQA-Bites.github.io/>openQA bites</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li class=navlinks-container><a class=navlinks-parent>openQA</a><div class=navlinks-children><a href=https://openQA-Bites.github.io/openqa/openqa-cli-cheat-sheet>openqa-cli cheat sheet</a></div></li><li><a title=Categories href=https://openQA-Bites.github.io/categories/>Categories</a></li><li><a title=Tags href=https://openQA-Bites.github.io/tags/>Tags</a></li><li><a title=About href=https://openQA-Bites.github.io/about/>About</a></li><li><a title=Related href=https://openQA-Bites.github.io/related/>Related</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="openQA bites" href=https://openQA-Bites.github.io/><img class=avatar-img src=https://openQA-Bites.github.io/img/avatar-icon.png alt="openQA bites"></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Run Azure images in Hyper-V or kvm</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on December 1, 2021
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;6&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;1124&nbsp;words
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;phoenix</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p><strong>Disclaimer: This blog post is about SUSE Linux Enterprise Server images on Azure and probably only useful to SUSE Employees who work with such images.</strong></p><p>Today I&rsquo;m gonna show, how Azure images can be tested on a Hyper-V machine. This might be useful if you need to debug issues while being in a more controlled environment than on the Azure cloud service provider. You will need a Windows machine with HyperV installed - I runs it on my Windows 10 Professional computer and on our internal Windows 2019 Server dedicated for virtualization.</p><p>Additionally, our publiccloud images (Azure, EC2 and GCE) also work fine in kvm (more specifically in <code>virt-manager</code>) by just importing the image file file. However, the procedure of setting the root password needs to be performed, otherwise you won&rsquo;t be able to login. It is completely analog to the one presented here for Hyper-V.</p><h1 id=tldr>TL;DR</h1><ul><li>You can boot Azure SLES images in Hyper-V</li><li>You need to rename the file ending from <code>vhdfixed</code> to <code>vhd</code></li><li>Use the hypervisor of <code>Generation 1</code></li><li>The root password is not set, so you will not be able to login</li><li>Use e.g. the openSUSE Leap Rescue CD to set the root password via a <code>chroot</code> environment</li></ul><p>Here is the procedure for setting a root password once you booted into the Rescue environment:</p><pre><code>(sudo -s)
# lsblk
# mount /dev/sda4 /mnt
# mount /dev/sda3 /mnt/boot
# chroot /mnt
# passwd
</code></pre><ul><li>Bonus: All SUSE publiccloud images (Azure, EC2, GCE) boot also within <code>virt-manager</code>, simply by importing the image file</li></ul><h1 id=booting-an-azure-image-in-hyper-v>Booting an Azure image in Hyper-V</h1><p>We start by downloading and prepare the image.</p><ul><li>Download and extract the image (it&rsquo;s <code>xz</code> packaged)</li><li>Rename the file ending from <code>vhdfixed</code> to <code>vhd</code></li><li>Create a new <code>Generation 1</code> virtual machine and select the downloaded image as primary HDD</li></ul><p>For this test run I pick the most recent <code>SLES15-SP3.x86_64-0.9.9-Azure-Standard-Build2.53.vhdfixed.xz</code> image and download it to the Hyper-V machine. Then you need to unpack it (e.g. <code>7zip</code>) and rename the file extension from <code>vhdfixed</code> to <code>vhd</code> so that Hyper-V recognises it.</p><p>Now create a new virtual machine in Hyper-V, and give it a fancy name (e.g. <code>betelgeuze</code> or <code>mr-small</code>). Important: Use a <code>Generation 1</code> type hypervisor, otherwise you won&rsquo;t be able to complete the process. Follow the wizard until you are at &ldquo;Connect Virtual Hard Disk&rdquo; and select the downloaded Azure image there:</p><p><img src=HyperV-Select-Disk.png alt="Select the downloaded Azure disk in the Connect Virtual Hard Disk section"></p><p>Now proceed to finish and you have your VM set up. It would boot as it is (don&rsquo;t get fooled by the sparse output!), however you can not login, because the root password is intentionally not set on those &ldquo;virgin&rdquo; images.</p><h2 id=setting-a-root-password>Setting a root password</h2><p>In order to be able to login, we first need to set a root password, as the root account is disabled. On our Azure images, the root interactions are expected to happen via <code>sudo</code>, so the root account is disabled in the <code>/etc/shadow</code> file. Setting a new root password will automatically re-enable it so we can login. For Azure , typically the cloud service provider creates a new user account with <code>sudo</code> rights for you, so this is only an issue on those &ldquo;virgin&rdquo; images, as we are dealing with right now. In those images, this user (<code>azureuser</code>) has no password and no ssh keys, so there is no way to log in:</p><pre><code># cat /etc/shadow
root:*:18757::::::
...
azureuser:!:18962:0:99999:7:::
</code></pre><p>There are many ways of solving this issue. My suggestion is that you download a openSUSE Leap Rescue DVD (Tumbleweed works just fine too), insert it into your VM, <code>chroot</code> into the system partition and set the root password with <code>passwd</code>. There are faster ways as this requires to walk a bit by foot, but it works reliably and shows you what you need in the end.</p><p><strong>To summarize we will do the following steps</strong>:</p><ol><li>Download the openSUSE Leap Rescue DVD (or any other Linux environment you&rsquo;re comfortable with)</li><li>Enter the VM settings</li><li>Select the Rescue-CD iso for the DVD Drive</li><li>Boot into the Rescue CD environment</li><li><code>chroot</code> into the system partition</li><li>Change the root password via <code>passwd</code></li><li>Reboot and select &ldquo;Boot from Hard Disk&rdquo;</li></ol><p>Let&rsquo;s go though this, one step at the time</p><ul><li>To download the Rescue DVD go to <a href=https://get.opensuse.org/leap>https://get.opensuse.org/leap</a> -> Download -> Alternative Downloads -> &ldquo;Rescue LiveCD&rdquo; and download the ISO from there. You can try <a href=https://download.opensuse.org/distribution/leap/15.3/appliances/iso/openSUSE-Leap-15.3-Rescue-CD-x86_64-Media.iso>this direct link</a> but it might break at some point, because I will forget update it when the next version is released :-)</li><li>Open the settings of your VM. Navigate to the CD settings and select the downloaded ISO image</li></ul><p><img src=HyperV-Settings.png alt="Select the VM settings">
<img src=HyperV-Settings-ISO.png alt="Set a the downloaded Rescue CD as Image file in for the DVD drive"></p><ul><li>Boot the VM. It should boot automatically into the Rescue environment (Live XFCE desktop)</li></ul><p><img src=HyperV-Rescue-Boot.png alt="The Hyper-V VM should boot into the Rescue system now"></p><ul><li>Open a terminal and mount the root filesystem under <code>/mnt</code> :</li></ul><p>The procedure is as follows:</p><pre><code>(sudo -s)
# lsblk
# mount /dev/sda4 /mnt
# mount /dev/sda3 /mnt/boot
# chroot /mnt
# passwd
</code></pre><p>Use the output of <code>lsblk</code> to determine the system partition. It is typically safe to assume that it is the largest partition. Here it is <code>/dev/sda4</code> with 28.5G. The partition before (<code>/dev/sda3</code>, 1GB) is the <code>/boot</code> partition, which we technically would not need to mount, but I still do it for completeness reasons.</p><p><em>Note: For GCE and EC2 images it is <code>/dev/sda3</code>, as the first partition (2M) is not present there. It is the biggest partition, so this is the signature you are looking for.</em></p><p><img src=HyperV-Rescue-Chroot.png alt="chroot into the system disk (typically /dev/sda4)"></p><ul><li>Now <code>reboot</code> the system (exit the <code>chroot</code> shell and then do a reboot)</li><li>Select &ldquo;Boot from Hard Disk&rdquo; in the Boot menu of the Rescue CD or eject the iso file in the VM settings</li></ul><p><img src=HyperV-Rescue-Boot-From-HDD.png alt="Select &amp;ldquo;Boot from Hard Disk&amp;rdquo; to boot the Azure image"></p><ul><li>Now you should be able to login as root with your newly set password (ignore the graphical artifacts)</li></ul><p><img src=HyperV-Booted.png alt="Booted and logged in SLES 15-SP3 image"></p><p>Congratulations! This is how you can run an SLES Azure image on your Hyper-V machine. Be aware that certain Azure-specific features will not be available: The <code>kernel-azure</code> package is installed, but the relevant hypervisor counter-part is (most probably) not available outside Azure.</p><h1 id=encore-using-an-azuregceec2-image-in-virt-manager>Encore: Using an Azure/GCE/EC2 image in <code>virt-manager</code></h1><p>The same procedure as above also works in <code>virt-manager</code>. The <code>vhd</code> image boots fine as a kvm-based virtual machine. All you need to do is to import the existing <code>vhd</code> image file as &ldquo;SUSE Linux Enterprise 15 SP3&rdquo; virtual machine.</p><p>Also here, the root account is disabled, so you need to set the root password in order to be able to login into your machine. You can simply add a SATA CDROM device and boot into a openSUSE Leap Rescue system, as explained above.</p><p>The Hyper-V hypervisor is closer to the Azure environment, so expect differences here. Don&rsquo;t be surprised if certain things work different here. That being said, it works and this alone might be already enough to do some issue investigation without the need to have access to the Azure cloud or a Hyper-V machine.</p><div class=blog-tags><a href=https://openQA-Bites.github.io//tags/sles/>SLES</a>&nbsp;
<a href=https://openQA-Bites.github.io//tags/publiccloud/>Publiccloud</a>&nbsp;
<a href=https://openQA-Bites.github.io//tags/hyper-v/>Hyper-V</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fopenQA-Bites.github.io%2fposts%2f2021-12-01-run-azure-image-on-hyperv%2f&text=Run%20Azure%20images%20in%20Hyper-V%20or%20kvm&via=grisu48" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fopenQA-Bites.github.io%2fposts%2f2021-12-01-run-azure-image-on-hyperv%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fopenQA-Bites.github.io%2fposts%2f2021-12-01-run-azure-image-on-hyperv%2f&title=Run%20Azure%20images%20in%20Hyper-V%20or%20kvm" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fopenQA-Bites.github.io%2fposts%2f2021-12-01-run-azure-image-on-hyperv%2f&title=Run%20Azure%20images%20in%20Hyper-V%20or%20kvm" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fopenQA-Bites.github.io%2fposts%2f2021-12-01-run-azure-image-on-hyperv%2f&title=Run%20Azure%20images%20in%20Hyper-V%20or%20kvm" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fopenQA-Bites.github.io%2fposts%2f2021-12-01-run-azure-image-on-hyperv%2f&description=Run%20Azure%20images%20in%20Hyper-V%20or%20kvm" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section></article><ul class="pager blog-pager"><li class=previous><a href=https://openQA-Bites.github.io/posts/2021-11-19-container-layer-analyzer/ data-toggle=tooltip data-placement=top title="Container Layer Analyzer">&larr; Previous Post</a></li><li class=next><a href=https://openQA-Bites.github.io/posts/2021-12-02-hyperv-nested-guest/ data-toggle=tooltip data-placement=top title="Windows VM and Hyper-V (nested virtualization)">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:felix.niederwanger@suse.de title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/grisu48 title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/grisu48 title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://reddit.com/u/grisu48 title=Reddit><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-reddit-alien fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/felix-niederwanger title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://chaos.social/@phoenix title=Mastodon><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-mastodon fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">phoenix
&nbsp;&bull;&nbsp;&copy;
2023
&nbsp;&bull;&nbsp;
<a href=https://openQA-Bites.github.io/>openQA bites</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.110.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script>
<script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script>
<script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script>
<script src=https://openQA-Bites.github.io/js/main.js></script><script>renderMathInElement(document.body)</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://openQA-Bites.github.io/js/load-photoswipe.js></script></body></html>